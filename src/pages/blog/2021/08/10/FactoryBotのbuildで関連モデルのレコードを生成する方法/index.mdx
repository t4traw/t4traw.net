---
layout: "@layouts/Blog.astro"
title: "FactoryBotã®buildã§é–¢é€£ãƒ¢ãƒ‡ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹æ–¹æ³•"
head: "blog"
date: "2021-08-10"
archives: ["2021/08"]
categories:
  - é–‹ç™º
tags:
  - rails
  - minitest
  - factory_bot
---

ã„ã¤ã‚‚æ··ä¹±ã™ã‚‹ FactoryBot ã®ã€Œã‚ã‚Œï¼Ÿã€ã£ã¦æ€ã†éƒ¨åˆ†ã‚’è¨˜äº‹ã«ã„ãã¤ã‹æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ ğŸ™‚

æ™®é€šã« name, email, password ã®ã‚·ãƒ³ãƒ—ãƒ«ãª User ãƒ¢ãƒ‡ãƒ«ã®ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹ã®ãªã‚‰ã€

```ruby
FactoryBot.define do
  factory :user do
    name { Faker::Internet.username }
    email { Faker::Internet.email }
    password { 'password' }
  end
end
```

ã¨ã„ã£ãŸå…·åˆã«ä½œæˆã§ãã¾ã™ã€‚

ã—ã‹ã—ã€ã“ã‚“ãªæ„Ÿã˜ã®ãƒ¢ãƒ‡ãƒ«é–¢ä¿‚ã ã£ãŸå ´åˆã€‚

```ruby
class User < ApplicationRecord
  belongs_to :group
end

class Group < ApplicationRecord
  has_many :users
end
```

Rails ã®ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¯ belongs_to ã®å ´åˆã€ã‚«ãƒ©ãƒ ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å¿…é ˆé …ç›®ï¼ˆnil ã¯ä¸å¯ï¼‰ã«ãªã£ã¦ã„ã¾ã™ã€‚ã‚‚ã—ã‚‚ä¸Šã®ä¾‹ã§ group_id ãŒ nil ã§è‰¯ã„ã®ãªã‚‰`optional: true`ã‚’æ›¸ã‹ãªã‘ã‚Œã°ã„ã‘ã¾ã›ã‚“ã€‚

ã“ã‚Œã‚’è¸ã¾ãˆãŸä¸Šã§ã€FactoryBot ã§æ›¸ãã¨

```ruby
FactoryBot.define do
  factory :user do
    name { Faker::Internet.username }
    email { Faker::Internet.email }
    password { 'password' }
    association :group
  end
end

FactoryBot.define do
  factory :group do
    name { Faker::Company.name }
  end
end
```

ã¨ã„ã£ãŸæ„Ÿã˜ã§æ›¸ãã¨æ€ã„ã¾ã™ã€‚ã“ã‚Œã§ç°¡å˜ã«ãƒ¢ãƒ‡ãƒ«ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã“ã†ã¨ã™ã‚‹ã¨ã€

```ruby
require "test_helper"

class UserTest < ActiveSupport::TestCase
  test "Userã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã§ãã‚‹" do
    user = FactoryBot.build(:user)
    assert user.save
  end
end
```

ã¿ãŸã„ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚

ã—ã‹ã—ã€ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãŒé€šã‚Šã¾ã›ã‚“ã€‚`FactoryBot.build(:user)`ã§é–¢é€£å…ˆã®ãƒ¢ãƒ‡ãƒ«ãŒç”Ÿæˆã•ã‚Œãªã„ã®ã§ã€å¿…é ˆé …ç›®ãŒåŸ‹ã¾ã£ã¦ã„ãªã„ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã¾ã™ ğŸ¤¢

`FactoryBot.create(:user)`ã ã¨é–¢é€£å…ˆã®ãƒ¢ãƒ‡ãƒ«ã‚‚ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã®ã§ã™ãŒã€å€‹äººçš„ã«ãƒ†ã‚¹ãƒˆã£ã¦`.save`ã‚„`.valid?`ã§ assert æ›¸ããŸã„ã‚“ã§ã™ã‚ˆã­ãƒ¼ã€‚

æœ¬æ¥ã¯å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãŒã‚ã‚‹ç‰©ã¯ç´ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã¹ãã ã‹ã‚‰ã€ã“ã†ã‚ã‚‹ã¹ããªã‚“ã ã‚ã†ã‘ã©ã€ä¿å­˜ã§ããªã„å ´åˆã¨ã‹ãƒ†ã‚¹ãƒˆã—ãŸã„æ™‚ã‚‚é–¢é€£ãƒ¢ãƒ‡ãƒ«ã¯ä½œã‚‰ã‚Œã¦ã„ãŸæ–¹ãŒã‚„ã‚Šã‚„ã™ã„ã¨æ€ã†ã‚“ã§ã™ã‚ˆã­ãƒ¼ã€‚

ã“ã‚Œã‚’è§£æ±ºã™ã‚‹æ–¹æ³•ã¯ã€

1. ä¸€æ‹¬ã§ build æ™‚ã§ã‚‚é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†
2. å€‹åˆ¥ã« build æ™‚ã§ã‚‚ç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹

ã® 2 ã¤ãŒã‚ã‚Šã¾ã™ âœŒï¸

## ä¸€æ‹¬ã§ build æ™‚ã§ã‚‚é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†

ã¾ãšä¸€æ‹¬ã§ build æ™‚ã«ç”Ÿæˆã™ã‚‹å ´åˆã§ã™ãŒã€`FactoryBot.use_parent_strategy = false`ã‚’å¿…è¦ãªã¨ã“ã‚ã§è¨­å®šã™ã‚Œã°ã€build æ™‚ã§ã‚‚é–¢é€£ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

â€»è¿½è¨˜: ã“ã‚Œã€æ›¸ã„ãŸå¾Œã® FactoryBot ã™ã¹ã¦ã«é©ç”¨ã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€teardown ã§æˆ»ã—ã¦ãŠã„ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ ğŸ˜“

```ruby
class UserTest < ActiveSupport::TestCase
  teardown do
    FactoryBot.use_parent_strategy = true
  end

  test "Userã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã§ãã‚‹" do
    FactoryBot.use_parent_strategy = false
    user = FactoryBot.build(:user)
    assert user.save
  end
end
```

## å€‹åˆ¥ã« build æ™‚ã§ã‚‚ç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹

factory ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–¹ã§ association ã‚’è¨­å®šã—ãŸæ™‚ã«ã€build ã§ã‚‚ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãäº‹ã‚‚ã§ãã¾ã™ã€‚

```ruby
FactoryBot.define do
  factory :user do
    name { Faker::Internet.username }
    email { Faker::Internet.email }
    password { 'password' }
    association :group, strategy: :create # <- ã‚³ã‚³
  end
end
```

ãŸã ã€ã“ã‚Œã¯ç°¡å˜ã«å¤‰ãˆã‚‰ã‚Œãªã„ã®ã§ã€ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä¿å­˜è‡ªä½“ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æ™‚ã ã‘ã€ä¸Šã®`FactoryBot.use_parent_strategy = false`ã®æ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ ğŸ˜†

ãã‚Œã§ã¯ ğŸ¤Ÿ

## å‚è€ƒ

- https://qiita.com/TunaGinger/items/ca08b1eaa5c1e321e302
- https://github.com/thoughtbot/factory_bot_rails/issues/314
